---
title: 'A4 -Análisis de varianza y repaso del curso'
author: "Autor: Eduardo Mora González"
date: "Enero 2023"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 75.584-PEC-header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

<style>
body {
text-align: justify}

```{r message= FALSE, warning=FALSE}
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
if (!require('VIM')) install.packages('VIM'); library('VIM')
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
if (!require('car')) install.packages('car'); library('car')
if (!require('grid')) install.packages('grid'); library('grid')
if (!require('corrplot')) install.packages('corrplot'); library('corrplot')
if (!require('caret')) install.packages('caret'); library('caret')
if (!require('plotly')) install.packages('plotly'); library('plotly')
if (!require('rgl')) install.packages('rgl'); library('rgl')
if (!require('scatterplot3d')) install.packages('scatterplot3d'); library('scatterplot3d')
if (!require('lmtest')) install.packages('lmtest'); library('lmtest')
if (!require('agricolae')) install.packages('agricolae'); library('agricolae')
if (!require('stats')) install.packages('stats'); library('stats')
if (!require('readr')) install.packages('readr'); library('readr')
```

</style>
# Preprocesado

Carga del archivo


```{r}
datos <- read_delim("C:/Users/eduar/Dropbox/ESTUDIOS/Estadística avanzada/PRACTICA FINAL/Fumadores.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
```

Y mostrar los tipos de datos y estaditica básica

```{r}
str(datos)
```

## Comprobación y transformación de la variable AE

Como vemos, la variable AE nos la ha identificado como tipo cadena, se va comprobar si existe alguna coma, y se va a pasar a numérico.

```{r}
#corregimos por si existe alguna coma
datos$AE <- gsub("\\,","\\.", datos$AE)

#Pasamos a numérico
datos$AE<- as.numeric(datos$AE)

```

Y vemos la estadísticas de todos los datos

```{r}
summary(datos$AE)
```

Vemos que los datos están dentro del rango, por lo que no se encuentran inconsistencias

## Comprobación y transformación de la variable Edad


```{r}
summary(datos$edad)
```

Vemos que los datos están dentro del rango, por lo que no se encuentran inconsistencias

## Comprobación y transformación de la variable Genero

Pasamos todos los datos a mayusculas antes de hacer las comprobaciones

```{r}
datos$genero <- toupper(datos$genero)
```

Comprobamos que existan solo dos tipos de género

```{r}
fem.idx <- which(datos$genero=="F")
mas.idx <- which( datos$genero=="M")
suma <- length(fem.idx) + length(mas.idx)
cat("La suma de todos los datos son:",suma)
```

Vemos que existen el mismo numero de observaciones que en la estructura del dataframe obtenida al inicio, por lo que no existe inconsistencias en la variable género.

## Comprobación y transformación de la variable Tipo

Pasamos todos los datos a mayusculas antes de hacer las comprobaciones

```{r}
datos$Tipo <- toupper(datos$Tipo)
```

Para esta variable, vemos que hay varios tipos, por lo que se obtendrá el índice de cada tipo para hacer las comprobaciones de los tipos con condiciones 

```{r}
NF.idx <- which(datos$Tipo=="NF")
FP.idx <- which(datos$Tipo=="FP")
NI.idx <- which(datos$Tipo=="NI")
FL.idx <- which(datos$Tipo=="FL")
FM.idx <- which(datos$Tipo=="FM")
FI.idx <- which(datos$Tipo=="FI")

#Comprobamos la suma de todos los registros
suma <- length(NF.idx) + length(FP.idx) + length(NI.idx) + length(FL.idx) + length(FM.idx) + length(FI.idx)
cat("La suma de todos los datos son:",suma)
```

Vemos que existen el mismo numero de observaciones que en la estructura del dataframe obtenida al inicio.

Obtenemos la edad mas pequeña y le sumamos 20 años, para las siguientes comprobaciones 


```{r}
min_edad<- min(datos$edad) + 20
cat("La edad es:",min(datos$edad), "y al sumarle 20 se ha quedado en:", min_edad)
```

### TIPO Fumadores ligeros (FL)

```{r}
FL.Edad.idx <- which((datos$Tipo=="FL") & (datos$edad < min_edad))
cat ("Hay", length(FL.Edad.idx), "que NO cumple la condicion")
```

Para estos 4 valores, se va a optar por cambiarle el tipo a otros que cumplan las condiciones.

```{r}
datos$Tipo[FL.Edad.idx[1]] <- "NF"
datos$Tipo[FL.Edad.idx[2]] <- "NI"
datos$Tipo[FL.Edad.idx[3]] <- "FP"
datos$Tipo[FL.Edad.idx[4]] <- "NF"
```

Y comprobamos

```{r}
FL.Edad.idx <- which((datos$Tipo=="FL") & (datos$edad < min_edad))
cat ("Ahora hay", length(FL.Edad.idx), "que NO cumple la condicion")
```

### TIPO Fumadores moderados (FM)

```{r}
FM.Edad.idx <- which((datos$Tipo=="FM") & (datos$edad < min_edad))
cat ("Hay", length(FM.Edad.idx), "que NO cumple la condicion")
```

Al ser solo dos, se va a aumentar la edad en 20 años para que se cumpla la condición 

```{r}
datos$edad[FM.Edad.idx[1]] <- datos$edad[FM.Edad.idx[1]] + 20
datos$edad[FM.Edad.idx[2]] <- datos$edad[FM.Edad.idx[2]] + 20
```

Y comprobamos

```{r}
FM.Edad.idx <- which((datos$Tipo=="FM") & (datos$edad < min_edad))
cat ("Ahora hay", length(FM.Edad.idx), "que NO cumple la condicion")
```

### TIPO Fumadores intensivos (FI)

```{r}
FI.Edad.idx <- which((datos$Tipo=="FI") & (datos$edad < min_edad))
cat ("Hay", length(FI.Edad.idx), "que NO cumple la condicion")
```

Para estos 5 valores, se va a optar por cambiarle el tipo a otros que cumplan las condiciones, y al estar dentro de los que fuman intensamente, se ha descartado el tipo NF.

```{r}
datos$Tipo[FI.Edad.idx[1]] <- "FP"
datos$Tipo[FI.Edad.idx[2]] <- "NI"
datos$Tipo[FI.Edad.idx[3]] <- "FP"
datos$Tipo[FI.Edad.idx[4]] <- "NI"
datos$Tipo[FI.Edad.idx[5]] <- "FP"
```

Y comprobamos

```{r}
FI.Edad.idx <- which((datos$Tipo=="FI") & (datos$edad < min_edad))
cat ("Ahora hay", length(FI.Edad.idx), "que NO cumple la condicion")
```

# Análisis descriptivo de la muestra

## Capacidad pulmonar y género

```{r}
ggplot(data = datos ,aes(x=AE,fill=genero))+geom_histogram(binwidth =0.1)+ggtitle("Capacidad pulmonar en relación al género")
```

A primera vista nos damos cuenta de que hay más registros de mujeres que de hombres. Por otro lado, los datos tienen una distribución normal mirándolo de una manera visual, aunque el grueso de los datos esta entre 0,9 y 2. A nivel de comparativa, los picos con más números de registros coinciden en parte en los dos géneros. Por otro lado, el rango de datos de las mujeres es mayor que la de los hombres.

## Capacidad pulmonar y edad

```{r}
plot(x = datos$AE, y = datos$edad, main="Relación entre capacidad pulmonar y edad")
```

Nos damos cuenta de que el mayor número de datos se encuentra entre los pacientes de 35 a 65 años. Por otro lado, la capacidad pulmonar de los pacientes se encuentra mayormente entre 1 y 2, ya que es donde se encuentra el mayor número de registros.

## Tipos de fumadores y capacidad pulmonar

```{r}
# Tabla resumen de los datos
resumen <- datos %>% group_by(Tipo) %>% summarize(Media_Tipo = mean(AE),Personas_Tipo = length(AE)); print(resumen)

#Histograma de la media por Tipo
ggplot(resumen, aes(x = reorder(Tipo, Media_Tipo), y = Media_Tipo)) + geom_col(color='#2F4F4F', fill='#E0FFFF') +
ggtitle("MEDIA POR TIPO")

ggplot(datos, aes(x = Tipo, y = AE)) + geom_boxplot(color='#EE6A50', fill='#EEE8AA')+
ggtitle("DISTRIBUCIÓN DE AE POR CADA TIPO DE FUMADOR")
```

En la tabla resumen podemos observar que donde mas registros hay son en los NF (no fumadores) que hay 50 registros y en el que menos son de FI (fumadores Intensivos) con 36 registros.

A nivel media del tipo, vemos que los No Fumadores o NF tienen mejor capacidad pulmonar, mientras que los Fumadores Moderados o FM son los que tienen peor. Por otro lado, los fumadores que inhalan el humo (FL, FM, FI) son los que tienen peor capacidad tienen.


# Intervalo de confianza de la capacidad pulmonar

## Supuestos

Los supuestos para el intervalo de confianza son si se puede suponer una distribución normal de los datos, y como se ha comprobado en el apartado anterior los datos en parte tienen una distribución normal

## División de los datos

```{r}
#Obtenemos los Indices de las mujeres
idx.mujer <- which(datos$genero == 'F')

#Creamos dos conjunto de datos depende del genero
datos_mujeres <- datos[idx.mujer,]
datos_hombres <- datos[-idx.mujer,]
```


Los supuestos para el intervalo de confianza son si se puede suponer una distribución normal de los datos, y como se ha comprobado en el apartado anterior los datos tienen una distribución normal.


## Función de cálculo del intervalo de confianza

Para realizar el cálculo, se va a crear una función para el cálculo. Dicha función se ha obtenido de practicas anteriores de la asignatura. 

```{r}
IC <- function( x, NC ){
  n <- length(x)
  alfa <- 1-(NC/100)
  sd <- sd(x)
  SE <- sd / sqrt(n)
  t <- qt( alfa/2, df=n-1, lower.tail=FALSE )
  L <- mean(x) - t*SE
  U <- mean(x) + t*SE
  return (c(L, U))
}

```

## Intervalo de confianza

```{r}
IC_Mujeres.AE.95<-IC(datos_mujeres$AE, 95); IC_Mujeres.AE.95
IC_Hombres.AE.95<-IC(datos_hombres$AE, 95); IC_Hombres.AE.95
```

##  Comprobación  

```{r}
t.test(datos_mujeres$AE, conf.level=0.95)
t.test(datos_hombres$AE, conf.level=0.95)
```

Vemos que los datos coinciden tanto en la salida de la función como la del test

## Interpretación

El intervalo de confianza del 95% de la media poblacional de AE de las mujeres es (1.428428, 1.618132), esto quiere decir que, si se sacan diferentes muestras de la población, el 95% de los intervalos calculados contienen el valor de la media poblacional.

El intervalo de confianza del 95% de la media poblacional de AE de los hombres es (1.482301, 1.685224), esto quiere decir que, si se sacan diferentes muestras de la población, el 95% de los intervalos calculados contienen el valor de la media poblacional.

## ¿se observan diferencias significativas en la capacidad pulmonar de mujeres y hombres?

No se encuentran diferencias significativa, ya que la salida de los IC tantos de los hombres como de las mujeres son muy similares.

# Diferencias en capacidad pulmonar entre mujeres y hombres

## Hipótesis

H0 : µAEMujer = µAEHombre

H1 : µAEMujer != µAEHombre

## Contraste

Es un test de dos muestras sobre la media con varianzas desconocidas. Por el teorema del límite central, podemos asumir normalidad. Comprobamos igualdad de varianzas:

```{r}
var.test( datos_hombres$AE, datos_mujeres$AE )
```

El resultado del test no muestra diferencias significativas entre varianzas. Por tanto, aplicaremos un test de dos muestras independientes sobre la media con varianzas desconocidas iguales. El test es bilateral.

## Función de cálculo

Para realizar el cálculo, se va a crear una función para el cálculo. Dicha función se ha obtenido de practicas anteriores de la asignatura. 

```{r}
funcion_contraste_medias <- function( x1, x2, CL=0.95, Var_Igual=TRUE, metodo_calculo="two.sided" ){
  
  media_1<-mean(x1)
  length_1<-length(x1)
  sd1<-sd(x1)
  
  media_2<-mean(x2)
  length_2<-length(x2)
  sd2<-sd(x2)
  
  
  if (Var_Igual==TRUE){
  
	  raiz <-sqrt( ((length_1-1)*sd1^2 + (length_2-1)*sd2^2 )/(length_1+length_2-2) )
	  Sb <- raiz*sqrt(1/length_1 + 1/length_2)
	  df<-(length_1 - 1) + (length_2 - 1)
	  
  }else{
  
	  Sb <- sqrt( sd1^2/length_1 + sd2^2/length_2 )
	  denominador <- ( (sd1^2/length_1)^2/(length_1-1) + (sd2^2/length_2)^2/(length_2-1))
	  df <- ( (sd1^2/length_1 + sd2^2/length_2)^2 ) / denominador
	  
  }

  alfa <- (1-CL)
  t<- (media_1-media_2) / Sb
  
  
  if (metodo_calculo=="two.sided"){
  
	  tcritical <- qt( alfa/2, df, lower.tail=FALSE )
	  pvalue<-pt( abs(t), df, lower.tail=FALSE )*2
	  
  }
  
  if (metodo_calculo=="greater"){
  
	  tcritical <- qt( alfa, df, lower.tail=FALSE )
	  pvalue<-pt( t, df, lower.tail=FALSE )	 
	  
  }
  
  if (metodo_calculo=="less"){
  
	  tcritical <- qt( alfa, df, lower.tail=TRUE )
	  pvalue<-pt( t, df, lower.tail=TRUE )
	    
  }
  
  
  resultados <-data.frame(t,tcritical,pvalue)

  return (resultados)

}
```

## Cálculos

```{r}
#Uso funcion implementada
funcion_contraste_medias( datos_hombres$AE, datos_mujeres$AE , CL=0.95, Var_Igual=TRUE, metodo_calculo = "two.sided")
```


```{r}
#Validación de la función
t.test(datos_hombres$AE, datos_mujeres$AE , var.equal=TRUE, conf.level = 0.95, alternative = "two.sided")
```

## Interpretación

El valor crítico para un nivel de confianza del 95% es 1,96946 y el valor observado es 0,85316. Por tanto, nos encontramos en la zona de aceptación de la hipótesis nula. Lo mismo se observa con el valor p, que da un valor de 0,3944, y por tanto, superior a alfa=0,05.

Concluimos que la capacidad pulmonar de los hombres no es distinta a la de las mujeres con un nivel de confianza del 95%.

# Diferencias en la capacidad pulmonar entre Fumadores y No Fumadores

## Hipótesis

H0 : µAEFumadores = µAENoFumadores

H1 : µAEFumadores < µAENoFumadores

## Preparación de los datos

```{r}
#Obtenemos los indices
No.fumadores.idx <- which((datos$Tipo=="NF") | (datos$Tipo=="FP"))

#Dividimos los datos
datos_fumadores <- datos$AE[-No.fumadores.idx]
datos_No_fumadores<- datos$AE[No.fumadores.idx]

```

## Contraste

Es un test de dos muestras sobre la media con varianzas desconocidas. Por el teorema del límite central, podemos asumir normalidad. Comprobamos igualdad de varianzas:

```{r}
var.test(datos_fumadores,datos_No_fumadores)
```
El resultado del test no muestra diferencias significativas entre varianzas. Por tanto, aplicaremos un test de dos muestras independientes sobre la media con varianzas desconocidas iguales. El test es bilateral.

## Cálculos

```{r}
#Uso funcion implementada
funcion_contraste_medias(datos_fumadores, datos_No_fumadores , CL=0.95, Var_Igual=TRUE, metodo_calculo = "two.sided")
```


```{r}
#Validación de la función
t.test(datos_fumadores, datos_No_fumadores, var.equal=TRUE, conf.level = 0.95, alternative = "two.sided")
```

## Interpretación

El valor crítico para un nivel de confianza del 95% es 1,96946 y el valor observado es -6,5645 Por tanto, nos encontramos en la zona de aceptación de la hipótesis alternativa. Lo mismo se observa con el valor p, que da un valor de 2.974e-10, y por tanto, muy inferior a alfa=0,05.

Concluimos que la capacidad pulmonar de los fumadores es menor de los que no lo son.

# Análisis de regresión lineal

## Cálculo

```{r}
#Creamos el modelo
ModelF <- lm(AE ~ Tipo + edad + genero, data=datos)

#Tabla resumen
summary(ModelF)
```

## Interpretación

Como se puede observar, tenemos un coeficiente de determinación del 0,54. Si comparamos la contribución de cada variable con la variable AE nos damos cuenta de:

+ Por cada incremento del Tipo FL, se espera que la capacidad pulmonar aumenta en 0,31836.

+ Por cada incremento del Tipo FM, se espera que la capacidad pulmonar aumenta en 0,02082.

+ Por cada incremento del Tipo FP, se espera que la capacidad pulmonar aumenta en 0,29359.

+ Por cada incremento del Tipo NF, se espera que la capacidad pulmonar aumenta en 0,71023.

+ Por cada incremento del Tipo NI, se espera que la capacidad pulmonar aumenta en 0,30672.

+ Por cada incremento de la edad, se espera que la capacidad pulmonar disminuya en 0,02973.

+ Si el género es masculino, se espera que la capacidad pulmonar aumenta en 0,002143.

Por lo que nos damos cuenta de que los No Fumadores son los que más hacen aumentar la capacidad pulmonar, y que, con el aumento de la edad, esta capacidad disminuye.

## Bondad de ajuste

Analizamos los residuos del modelo

```{r}
confint(ModelF)
```

```{r}
influencePlot(ModelF)
```

Con este grafico y su salida, nos damos cuenta de que tenemos 4 datos atípicos.

Relación lineal entre los predictores numéricos y la variable dependiente:

```{r}
ggplot(data = datos, aes(x = AE, y = ModelF$residuals)) +
geom_point() +
geom_smooth(color = "firebrick") +
geom_hline(yintercept = 0) +
theme_bw()
```

Se satisface la condición de linealidad.

Distribución normal de los residuos:

```{r}
qqnorm(ModelF$residuals)
qqline(ModelF$residuals)
```

La condición de normalidad se satisface.

Variabilidad constante de los residuos:

```{r}
ggplot(data = data.frame(predict_values = predict(ModelF),
                         residuos = residuals(ModelF)),
       aes(x = predict_values, y = residuos)) +
    geom_point() +
    geom_smooth(color = "firebrick", se = FALSE) +
    geom_hline(yintercept = 0) +
    theme_bw()
```

Se satisface la variabilidad constante

## Predicción

```{r}
cont = 0
prediccion.NF <- 0:50
prediccion.FP <- 0:50
prediccion.NI <- 0:50
prediccion.FL <- 0:50
prediccion.FM <- 0:50
prediccion.FI <- 0:50

for (i in 30:81) {
  NF <- data.frame(edad=i, Tipo="NF", genero="M")
  FP <- data.frame(edad=i, Tipo="FP", genero="M")
  NI <- data.frame(edad=i, Tipo="NI", genero="M")
  FL <- data.frame(edad=i, Tipo="FL", genero="M")
  FM <- data.frame(edad=i, Tipo="FM", genero="M")
  FI <- data.frame(edad=i, Tipo="FI", genero="M")
  prediccion.NF[cont]<- predict(object=ModelF, newdata=NF)
  prediccion.FP[cont]<- predict(object=ModelF, newdata=FP)
  prediccion.NI[cont]<- predict(object=ModelF, newdata=NI)
  prediccion.FL[cont]<- predict(object=ModelF, newdata=FL)
  prediccion.FM[cont]<- predict(object=ModelF, newdata=FM)
  prediccion.FI[cont]<- predict(object=ModelF, newdata=FI)
  cont = cont + 1
}

edad <- 30:80

tabla <- data.frame(edad,prediccion.NF,prediccion.FP,prediccion.NI,prediccion.FL,prediccion.FM,prediccion.FI); tabla
```

Y visto de manera grafica la tabla anterior con las predicciones

```{r}
plot(tabla$edad, tabla$prediccion.NF, type = "o", main = "Predicción del AE de los NF")
plot(tabla$edad, tabla$prediccion.FP, type = "o", main = "Predicción del AE de los FP")
plot(tabla$edad, tabla$prediccion.NI, type = "o", main = "Predicción del AE de los NI")
plot(tabla$edad, tabla$prediccion.FL, type = "o", main = "Predicción del AE de los FL")
plot(tabla$edad, tabla$prediccion.FM, type = "o", main = "Predicción del AE de los FM")
plot(tabla$edad, tabla$prediccion.FI, type = "o", main = "Predicción del AE de los FI")
```

# ANOVA unifactorial

## Normalidad

```{r}
qqnorm(datos$AE) 
qqline(datos$AE)
shapiro.test(datos$AE)
```

El test de Shapiro indica que tenemos evidencia suficiente para rechazar la hipótesis nula al tener un p-value inferior a 0.05, por lo tanto la variable AE no tiene una distribución normal

## Homoscedasticidad: Homogeneidad de varianzas

```{r}
bartlett.test(datos$AE ~ datos$Tipo)
```

El test de Bartlett indica que no tenemos evidencia suficiente para rechazar la hipótesis nula (las varianzas son iguales) al tener un p-value superior a 0.05

## Hipótesis nula y alternativa

H0 : AE_NF = AE_FP = AE_NI = AE_FL = AE_FM = AE_FI

H1 : AEi != AEj por algún i != j e i, j ∈ [AE_NF,  AE_FP,  AE_NI,  AE_FL,  AE_FM,  AE_FI]

## Cálculo ANOVA

```{r}
fm<- aov( lm(AE~Tipo, data=datos) )
summary(fm)
```

## Interpretación

Observamos que el valor del estadístico F es bastante mayor que la unidad hecho que indica que MSA > MSE y por tanto existe algún αi ̸= 0. De forma adicional, el valor p es claramente inferior a un nivel de significancia α del 5% y consecuentemente aceptamos la hipótesis alternativa para concluir que el factor Tipo es significativo.

Si lo comparamos con el gráfico del boxplot mostrado en el apartado 2.3, nos damos cuenta de que cada tipo de fumadores son diferentes, por lo que se acepta la hipótesis alternativa de que no existe un tipo de fumador con la misma capacidad o rango de AE.

## Normalidad Residuos

Los gráficos y descriptivos nos informan si se verifica la igualdad de varianzas en los grupos descritos:

```{r}
summary(fm$residuals)
```

```{r}
boxplot(fm$residuals)
hist(fm$residuals)
```

```{r}
qqnorm(fm$residuals) 
qqline(fm$residuals)
```

```{r}
shapiro.test(fm$residuals)
```

El test de Shapiro-Wilk indica que tenemos evidencia suficiente para rechazar la hipótesis nula (no normalidad de los residuos)

## Homoscedasticidad: Homogeneidad de varianzas de los Residuos

Los gráficos y descriptivos nos informan si se verifica la igualdad de varianzas en los grupos descritos:

```{r}
boxplot(fm$residuals~datos$Tipo)  
```

```{r}
desviaciones <- tapply(fm$residuals, datos$Tipo, sd)
max(desviaciones) / min(desviaciones)    
```
Comparando la desviación máxima con la mínima obtenemos una orientación sobre que no falta homocedasticidad al no tener un valor superior a 2

```{r}
bartlett.test(fm$residuals ~ datos$Tipo)
```
El test de Bartlett indica que no tenemos evidencia suficiente para rechazar la hipótesis nula (las varianzas son iguales).

## Profundizando en ANOVA

La suma de cuadrados totales:

```{r}
SSTotal <- var( datos$AE ) * (nrow(datos)-1)

cat("El valor del SST es:", SSTotal)
```
Hacemos otra comprobación para saber que se ha calculado bien 

```{r}
SS <- anova(fm)['Sum Sq']
SST <- sum(SS)
cat("El valor del SST es:", SST)
```

El valor de SST mide la variabilidad en los datos asociada al efecto del factor sobre la media (la diferencia de las medias entre los diferentes niveles o grupos).

La Suma de Errores cuadrados de es:

```{r}
#Calculo SSW
SSW <- sum( fm$resid^2 )
cat("El valor del SSW es:", SSW)

```

```{r}
#Calulo SSB
SSB <- SSTotal - SSW
cat("El valor del SSB es:", SSB)
```

Bajo la Ho el estadístico de contraste F se distribuye como una F de grados de libertad (I-1), (n-I) donde I es el número de grupos que disponemos y n el tamaño total de la muestral. Así obtenemos el cuantil buscado:

```{r}
qf(0.05, 5-1, 16-5, lower.tail = F)
```

Valores del estadístico > 3.35669 estarán incluidos en la región de rechazo. En nuetro caso 18.23 es mucho mayor que el valor crítico obtenido.

```{r}
dfE   <- fm$df.residual
dfReg <- nrow(datos) - 1 - dfE
MSreg <- SSB / dfReg
MSE   <- SSW / dfE
Fstat <- MSreg / MSE
pval  <- pf( Fstat , dfReg, dfE , lower.tail=FALSE )
cat("El valor de P-Value es:", pval)
```

## Fuerza de la relación

```{r}
fuerza.relación <- SSB/ SST
fuerza.relación
```
La fuerza de la relación representa que en 0.2695832 la variable Tipo tiene conocimiento de pertenenecia frente la variable AE.

# Comparaciones múltiples

## Test pairwise

```{r}
pairwise.t.test(datos$AE, datos$Tipo)
```

Del resultado podemos ver que hay varios valores p menor que 0.05, por lo tanto, concluiríamos que para esos casos hay una diferencia estadísticamente significativa en la capacidad pulmonar (AE) entre los encuestados de esos Tipos.

## Corrección de Bonferroni

```{r}
pairwise.t.test(datos$AE, datos$Tipo , p.adj='bonferroni')
```

Vemos que la corrección hace que los datos se alteren un poco (teniendo un valor mas alto), pero se sigue manteniendo los casos en donde existe una diferencia estadísticamente significativa en la capacidad pulmonar (AE) entre los encuestados de esos Tipos.

# ANOVA multifactorial

## Análisis visual

```{r}
mujeres <- datos_mujeres %>%  group_by(Tipo) %>%  summarise(media_AE = mean(AE))
mujeres$genero <- "F"
hombres <- datos_hombres %>%  group_by(Tipo) %>%  summarise(media_AE = mean(AE))
hombres$genero <- "M"
datos_media <- merge( mujeres, hombres, all = TRUE)
datos_media
```

Visto de una manera grafica:

```{r}
interaction.plot(datos_media$genero,datos_media$Tipo,datos_media$media_AE)
```

En el gráfico se observa que existe interacción en los efectos de las variables género y Tipo sobre la variable AE ya que el nivel M de la variable género incrementa la respuesta de AE para los niveles FI, FL, FP y NF, en cambio disminuye la respuesta de AE para él los tipos NI y FM.

## ANOVA multifactorial

```{r}
mod_m <- aov(AE~genero*Tipo, data = datos)
anova(mod_m)
```

## Interpretación

Observamos en los resultados del ANOVA que los estadísticos F de los factores principales (genero y Tipo) no son significativos (p valor superior al nivel de significancia), por tanto no aceptamos que hay efecto del Tipo y del genero.

Las medias por niveles de los factores e interacciones son las siguientes:

```{r}
model.tables(mod_m, type = "means")
```

Los efectos de los principales factores y de las interacciones son:

```{r}
model.tables(mod_m, type = "effects")
```

Debido a que los factores principales son significativos realizaremos comparaciones por parejas. Empezaremos por la variable genero:

```{r}
HSD.test(mod_m, "genero", console = TRUE)
```

Observamos que los niveles M y F son significativamente poco diferentes entre sí y por tanto forman un solo grupo (a).

Ahora haremos la comparación con la variable Tipo:

```{r}
HSD.test(mod_m, "Tipo", console = TRUE)
```

Observamos un primer grupo solo con el nivel NF, por otro lado los niveles FP, NI, FL son significativamente poco diferentes entre sí y por tanto forman un grupo
(b), mientras que si son significativamente diferentes con el nivel FI y FM que entre si forman otro grupo (c) y con el grupo anterior (a).

Por último realizamos el estudio de las interacciones pues hemos obtenido anteriormente que éstas son significativas.

```{r}
inter <- with(datos, interaction(genero, Tipo))
mod_m_i<-aov(AE~inter, data = datos)
HSD.test(mod_m_i, "inter", console = TRUE)
```

Observamos que el HSD test detecta 4 grupos no homogéneos (a,b,c y d).

Ahora veremos la adecuación del modelo ANOVA obtenido utilizando los gráficos de los residuos:

```{r}
plot(mod_m, which = c(1,2))
```

Analizamos la normalidad de los residuos con el test de Shapiro-Wilk

```{r}
shapiro.test(residuals(mod_m))
```

Obtenemos un valor p pequeño (inferior a 0.05), rechazamos la hipótesis nula en favor de la alternativa y podemos decir que la distribución no es normal, por tanto el modelo anova no es adecuado.

# Resumen técnico

| N | APARTADO | DESCRIPCIÓN | CONCLUSIÓN|
|:-:|:-:|---------|---------|
| 1 | 1.4.1 | Hay 4 casos que no cumple la condición para el tipo FL “personas que fuman e inhalan de uno a 10 cigarrillos al día durante 20 años o más” | Se le asigna valores que cumplan la condición |
| 2 | 1.4.2 | Hay 2 casos que no cumple la condición para el tipo FM “personas que fuman e inhalan de uno a 10 cigarrillos al día durante 20 años o más” | Se aumenta la edad para que se cumpla la condición |
| 3 | 1.4.3 | Hay 5 casos que no cumple la condición para el tipo FI “personas que fuman e inhalan de uno a 10 cigarrillos al día durante 20 años o más” | Se le asigna valores que cumplan la condición, sin asignar el valor de NF |
| 4 | 3 | El intervalo de confianza del 95% de la media poblacional de AE de las mujeres es (1.428428, 1.618132) y el de los hombres (1.482301, 1.685224) | No se muestran diferencias significativas en la capacidad pulmonar de mujeres y hombres |
| 5 | 4 | El valor crítico para un nivel de confianza del 95% es 1,96946 y el valor observado es 0,85316. Por tanto, nos encontramos en la zona de aceptación de la hipótesis nula. Lo mismo se observa con el valor p, que da un valor de 0,3944, y por tanto, superior a alfa=0,05. | La capacidad pulmonar de los hombres no es distinta a la de las mujeres con un nivel de confianza del 95%.|
| 6 | 5 | El valor crítico para un nivel de confianza del 95% es 1,96946 y el valor observado es -6,5645 Por tanto, nos encontramos en la zona de aceptación de la hipótesis alternativa. Lo mismo se observa con el valor p, que da un valor de 2.974e-10, y por tanto, muy inferior a alfa=0,05 | La capacidad pulmonar de los fumadores es menor de los que no lo son |
| 7 | 6 | El modelo de regresión lineal tiene un coeficiente de determinación del 0,54, con 4 datos atípicos (37, 85, 223 y 230), pero se satisface la normalidad y la variabilidad es constante | El modelo de regresión lineal muestra datos bastante coherentes en las predicciones generadas para cada tipo de fumador entre los 30 y 80 años, viendo que la capacidad pulmonar de los no fumadores es mayor de los que lo son, y que esta capacidad disminuye con la edad |
| 8 | 7.5 | Observamos que el valor del estadístico F es bastante mayor que la unidad hecho que indica que MSA > MSE y por tanto existe algún αi ̸= 0. De forma adicional, el valor p es claramente inferior a un nivel de significancia α del 5% y consecuentemente aceptamos la hipótesis alternativa para concluir que el factor Tipo es significativo | Se acepta la hipótesis alternativa de que no existe un tipo de fumador con la misma capacidad o rango de AE |
| 9 | 7.9 | El valor del SST es: 78.48591, el valor del SSW es: 57.32743, el valor del SSB es: 21.15848 y la fuerza de la relación es: 0.2695832 | Con los datos anteriores se ha podido calcular el valor de P-Value que es: 2.145587e-15 |
| 10 | 8.1 | Del Test pairwise vemos varios valores p menor que 0.05  | Para esos casos (p menor que 0.05) hay una diferencia estadísticamente significativa en la capacidad pulmonar (AE) entre los encuestados de esos Tipos |
| 11 | 8.2 | De la Corrección de Bonferroni nos damos cuenta de que los datos se han alterado un poco (teniendo un valor mas alto) | Se mantienen los casos en donde existe una diferencia estadísticamente significativa en la capacidad pulmonar (AE) entre los encuestados de esos Tipos |
| 12 | 9.1 | Se crea un grafico de interacción donde se muestran todas la relación de la variable Tipo, AE y Genero | Existe interacción en los efectos de las variables género y Tipo sobre la variable AE ya que el nivel M de la variable género incrementa la respuesta de AE para los niveles FI, FL, FP y NF, en cambio disminuye la respuesta de AE para él los tipos NI y FM |
| 13 | 9.3 | Observamos en los resultados del ANOVA que los estadísticos F de los factores principales (genero y Tipo) no son significativos (p valor superior al nivel de significancia) | No aceptamos que hay efecto del Tipo y del genero |


# Resumen ejecutivo

En este estudio sobre la base de datos que contenía 4 variables principales: Capacidad Pulmonar (AE), Edad, Tipo de fumador y genero se ha realizado diferentes análisis de lo que cabe destacar la siguientes conclusiones:

Tras realizar distintos cálculos para obtener el intervalo de confianza de la capacidad pulmonar, se ha visto que no hay diferencias significativa en la capacidad pulmonar de los hombres y de las mujeres. 
 
Para contrastar el resultado anterior, se ha hecho un contraste de hipótesis en donde la hipótesis nula es que la capacidad pulmonar es igual en hombres y mujeres, mientras que en la hipótesis alternativa esta capacidad es distinta. El resultado del contraste de hipótesis ha sido el mismo que en del intervalo de confianza, no existiendo diferencia en la capacidad pulmonar.

Siguiendo con el contraste de hipótesis, se ha querido realizar una comparación entre los tipos de fumadores, dividiéndolos en No fumadores (No fumadores y fumadores pasivos) y fumadores (resto de tipos). El resultado ha sido que la capacidad pulmonar de los fumadores es menor de los que no lo son.

Cambiando de modelo de análisis, se ha creado un modelo de regresión lineal para investigar la relación de la capacidad pulmonar con el resto de las variables. El modelo ha obtenido un coeficiente de determinación del 0,54. Aunque el coeficiente no es muy alto, si nos damos cuenta de que los No Fumadores son los que más hacen aumentar la capacidad pulmonar, y que, con el aumento de la edad, esta capacidad disminuye.
Esta ultima afirmación se ha confirmado en la predicción del modelo, creando una predicción por cada tipo, de un sujeto masculino y por cada año contemplado entre los 30 y los 80 años.

Con el uso de Anova unifactorial, se ha querido comparar la capacidad pulmonar entre los 6 tipos distintos de fumadores. El resultado ha mostrado de que cada tipo de fumador es diferente, por lo que se acepta la hipótesis alternativa de que no existe un tipo de fumador con la misma capacidad o rango de AE. 

Finalmente, con el Anova multifactorial se ha añadido al modelo anterior la del genero de los encuestados, pero ha concluido que no existe diferencia significativa entre el tipo y el género de cada encuestado en relación con la capacidad pulmonar.



